(function(){const T=new Map([[/youtube\.com\/api\/timedtext/i,"youtube"],[/cf-timedtext\.aux\.pv-cdn\.net/i,"primevideo"],[/hls\.ted\.com\/project_masters\/.*?\/subtitles\/.*?\/full\.vtt/i,"ted"],[/coursera\.org\/api\/subtitleAssetProxy/i,"coursera"],[/khanacademy\.org\/api\/internal\/graphql\/GetSubtitles/i,"khanacademy"]]),m=new Map([[/youtube\.com\/youtubei\/v1\/player/i,"youtube"],[/atv-ps-eu\.amazon\.co\.uk\/cdp\/catalog\/GetPlaybackResources/i,"primevideo"]]);function I(t){for(const[e,s]of T)if(e.test(t))return s;return null}function y(t){for(const[e,s]of m)if(e.test(t))return s;return null}const c=XMLHttpRequest.prototype,H=c.open,g=c.send,v=c.setRequestHeader,R=window.fetch;function E(t){return{eventType:t.eventType,source:"inject",data:{...t}}}function l(t){try{const e=E(t);window.postMessage(e,window.location.origin)}catch{}}function w(){c.open=function(t,e,s,i,a){const n=this;return n._method=t,n._url=typeof e=="string"?e:e.toString(),n._requestHeaders={},n._startTime=new Date().toISOString(),H.call(this,t,e,s??!0,i,a)},c.setRequestHeader=function(t,e){const s=this;return s._requestHeaders||(s._requestHeaders={}),s._requestHeaders[t]=e,v.apply(this,[t,e])},c.send=function(t){const e=this;return this.addEventListener("load",function(){var h,p,u,d;const s=I(e._url||""),i=y(e._url||""),a={};try{const o=this.getAllResponseHeaders();o&&o.split(`\r
`).forEach(f=>{const r=f.split(": ");r.length===2&&(a[r[0].toLowerCase()]=r[1])})}catch(o){console.warn("获取响应头失败:",o)}let n=null;try{this.responseType===""||this.responseType==="text"?n=this.responseText:this.responseType==="json"?n=JSON.stringify(this.response):this.responseType==="document"&&(n=this.responseXML?this.responseXML.documentElement.outerHTML:null)}catch(o){console.warn("获取响应数据失败:",o);return}if(n)if(s){const o=((p=(h=e._url)==null?void 0:h.split("?")[1])==null?void 0:p.split("&"))||[],f=((u=o.find(r=>r.startsWith("tlang=")))==null?void 0:u.split("=")[1])||((d=o.find(r=>r.startsWith("lang=")))==null?void 0:d.split("=")[1]);if(s==="youtube"){const r=new URL(e._url||"").searchParams.get("v"),_=new URL(location.href).searchParams.get("v");(r===_||!_)&&l({eventType:"ANYDOC_SUBTITLE_DATA",site:s,videoId:_||void 0,data:n,url:e._url||"",method:e._method||"",language:f,requestHeaders:e._requestHeaders||{},responseHeaders:a})}else l({eventType:"ANYDOC_SUBTITLE_DATA",site:s,data:n,url:e._url||"",method:e._method||"",language:f,requestHeaders:e._requestHeaders||{},responseHeaders:a})}else i&&l({eventType:"ANYDOC_VIDEO_INFO",site:i,data:n,url:e._url||"",method:e._method||"",requestHeaders:e._requestHeaders||{},responseHeaders:a})}),g.apply(this,[t])}}function O(){window.fetch=async function(t,e){const s=typeof t=="string"?t:t.url,i=y(s),a={},n=await R(t,e);if(i&&n.ok){const p=await n.clone().text(),u={};if(n.headers.forEach((d,o)=>{u[o.toLowerCase()]=d}),i){const d=new URL(s).searchParams.get("v");l({eventType:"ANYDOC_VIDEO_INFO",site:i,videoId:d||void 0,data:p,url:s,method:(e==null?void 0:e.method)||t.method||"GET",language:"",requestHeaders:a,responseHeaders:u})}}return n}}(function(){w(),O()})()})();
